---
title: JMP PAC OncoPrint complex Heatmap
author: Kasonde Chewe
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_notebook
---


# Description  
## last modified: 08/13/2024

Oncoplots are visualizations generated by `ComplexHeatmap` that effectively summarize mutation types across samples. Conceptually, these can be represented as an \( M \times N \) matrix, where \( M \) corresponds to the genes (rows) and \( N \) represents the samples (columns).

In this matrix representation, each element \( a_{ij} \) of the matrix corresponds to a cell in the oncoplot, where \( i \) denotes a specific gene and \( j \) denotes a specific sample. The value at each position \( a_{ij} \), is a string that encodes all possible mutation types observed for gene \( i \) in sample \( j \). These mutation types are typically concatenated into a single string using a delimiter (e.g., ";").

The dataset for these oncoplots is usually prepared by summarizing mutation data, which can be extracted from Mutation Annotation Format (MAF) files or Variant Call Format (VCF) files.

Two primary tools are used to construct these informative figures:

1. **ComplexHeatmap:** For creating heatmaps that can be tailored to display various genetic alterations across a cohort of samples.
2. **Circos:** For generating circular plots that can show relationships and patterns across different chromosomes and samples (not used directly in this script but commonly paired with oncoplots for comprehensive genomic visualizations).

```{r, include=FALSE, echo=FALSE}
# Clear environment variables 
rm(list=ls())
gc()
```


```{r}
source("~/Projects/JMP_PAC/00_SCRIPTS_R/bin/R/utilities/02.oncoplot_helpers.R")

# Load the ComplexHeatmap packag
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressWarnings(library(readxl))
suppressWarnings(library(ggplot2))
suppressWarnings(library(forcats))
suppressMessages(library(dplyr))
suppressWarnings(library(tidyverse))
suppressWarnings(library(grid))
```


## Loading Datasets for Mutation Analysis

The datasets loaded for mutation analysis in this project serve various purposes, each contributing uniquely to the comprehensive assessment of genetic alterations and their clinical implications:

1. **Summary Report (sreport_sheet3)**: This dataset provides a detailed report of molecular alterations across genes, summarizing the types and frequencies of mutations observed in the study cohort.

2. **Clinical Dataset (Masterlist)**: Contains clinical data for all patients included in the study. This masterlist links genetic data with patient identifiers, clinical outcomes, and other relevant clinical parameters.

3. **Summary Data for Recurred Patients**:
    - **RecurredPatientMutations**: Details specific mutation events in patients who have experienced recurrence of disease.
    - **RecurredPatientMutations_Summary**: Provides a summarized view of the mutation landscape in recurred patients, focusing on key genetic changes that might be linked to disease progression.

4. **Unfiltered Dataset of Mutations (Mutations_Unfiltered)**: Includes comprehensive mutation data before any filtering for quality or relevance. This dataset allows for initial explorations and assessments of the raw genetic data.

Each dataset is crucial for building a robust analysis framework, aiding in the development of targeted therapies and better understanding of the genetic underpinnings of disease recurrence and progression.

```{r}
# Load Mutation Summaries from CARIS REPORTS
sreport_sheet3 <- read_xlsx(path = "~/Projects/JMP_PAC/datasets/excels/summaries/jmp_pac_mutation_summary_v2.xlsx") # update for final pipeline (mutation summary report)
head(sreport_sheet3)
dim(sreport_sheet3)
colnames(sreport_sheet3)
cat("Mutation Summaries loaded!!!\n")

# Load Main Datasets ----
mst_list <- read_xlsx("~/final-project-dir/JMP_PAC/datasets/clinical/JMP_PaC_NAFLD_n502_Extended_Dataset.xlsx")
head(mst_list)
dim(mst_list)
colnames(mst_list)
cat("Main dataset loaded!!!\n")

# Extract sub-dataframe of patients with sequencing
sequenced <- mst_list %>% dplyr::select(`JMP_PAC ID`, `Res_CARIS ID`, 
                                        `Res_SEQ-WTS (Y/N)`, `Res_SEQ-WES (T/F)`, 
                                        `NASH/NAFLD Status (Y/N)`)
# Filter rows where `Res_CARIS ID` is Y only (patients with WTS sequencing)
wts_sequenced <- sequenced %>% dplyr::filter(`Res_SEQ-WTS (Y/N)` == "Y")
cat("Filtered sequenced patients.\n")

# Load previously saved file paths
wts_sequenced <- read_xlsx("~/Projects/JMP_PAC/datasets/excels/summaries/jmp_pac_sequenced.xlsx")
cat("Loaded XML file paths!!!\n")

```


## Generating Matrix of Molecular Consequences

### Task Overview
For the final presentation, this section focuses on the creation of a matrix that categorizes molecular consequences of mutations. It is vital for distinguishing between somatic and germline mutation types, which have different implications in the study of genetic diseases and cancer. For our dataset we process only somatic mutations

### Mutation Types Included in Analysis
The data contains a range of mutation types, each classified based on its genetic impact:
- **Frameshift**: Mutations that alter the reading frame of the protein-coding DNA sequence.
- **MISSENSE**: Mutations where the change of a single base pair causes the substitution of a different amino acid in the resulting protein.
- **SPLICING**: Mutations that affect the splicing of mRNA during the processing of the initial transcript.
- **Nonsense**: Mutations that introduce a premature stop codon into the mRNA sequence, leading to truncated, non-functional protein.
- **CODON INSERTION**, **CODON DELETION**: Mutations that either insert or delete nucleotides in the codons of the gene.
- **SYNONYMOUS**: Mutations that change a base pair but do not change the amino acid and hence have no impact on the protein sequence.
- **START LOST**: Mutations that affect the start codon and potentially prevent the initiation of translation.
- **NONCODING**: Mutations that occur outside of the coding sequences of genes.
- **CODON_CHANGE_PLUS_CODON_DELETION**: A complex mutation involving changes and deletions within the codons.

### Filtering Approach
The section also includes a filtering process where mutation types are sorted and analyzed based on specific JMP_PAC IDs. This method allows for targeted analysis of mutations in individual patients or groups, supporting refined interpretations and customized treatments.


```{r}
# Set gene column as row names and remove it from the matrix
jmp_matrix <- sreport_sheet3 %>%
  group_by(gene, jmp_pac_id) %>%
  summarize(mutation_consequence = paste(unique(molecularConsequence), collapse = ";"), .groups = 'drop') %>%
  pivot_wider(names_from = jmp_pac_id, values_from = mutation_consequence, values_fill = list(mutation_consequence = "Normal")) %>%
  filter(!is.na(gene)) %>%  # Remove rows where 'gene' is NA
  column_to_rownames(var = "gene") %>%
  as.matrix()

```




```{r}
# Convert the matrix back to a long dataframe for easier manipulation
jmp_matrix_long <- as.data.frame(as.table(jmp_matrix), stringsAsFactors = FALSE)
colnames(jmp_matrix_long) <- c("gene", "JMP_PAC_ID", "mutation_consequence")

# clean matrix further
jmp_matrix_long_clean <- jmp_matrix_long %>%
  mutate(mutation_consequence = str_remove_all(mutation_consequence, ";NA")) %>%
  mutate(mutation_consequence = str_remove_all(mutation_consequence, "NA;")) %>%
  mutate(mutation_consequence = str_replace(mutation_consequence, "^NA$", "")) %>%
  filter(mutation_consequence != "")

# Remove leading and trailing semicolons in case of any leftovers
jmp_matrix_long_clean <- jmp_matrix_long_clean %>%
  mutate(mutation_consequence = str_trim(mutation_consequence, side = "both")) %>%
  mutate(mutation_consequence = str_remove(mutation_consequence, "^;")) %>%
  mutate(mutation_consequence = str_remove(mutation_consequence, ";$"))

# Clean the mutation_consequence column
jmp_matrix_long_clean <- jmp_matrix_long_clean %>%
  mutate(mutation_consequence = str_replace_all(mutation_consequence, "_", " ")) %>%
  mutate(mutation_consequence = str_to_upper(mutation_consequence))

# Convert the long format back to a wide format matrix embedding combined molecular consequences
final_matrix <- jmp_matrix_long_clean %>%
  pivot_wider(id_cols = gene, names_from = JMP_PAC_ID, values_from = mutation_consequence) %>%
  as.data.frame() %>%
  column_to_rownames(var = "gene") %>%
  as.matrix()

# Ensure that the matrix has no NA values by replacing NA with "Normal" or any other placeholder
final_matrix[is.na(final_matrix)] <- "NORMAL"

```



```{r EXTRACT TOP 30 MUTATED GENES}
# Get top 30 mutated genes
# Count the number of mutations (non-"Normal" and non-empty) for each gene
mutation_counts <- apply(final_matrix, 1, function(x) sum(x != "NORMAL" & x != ""))
top_genes <- sort(mutation_counts, decreasing = TRUE)[1:30]
names_top_genes <- names(top_genes)
matrix_top30 <- final_matrix[names_top_genes, ]

# Calculate mutation frequencies (non-"Normal" and non-NA entries)
mutation_frequencies <- colSums(matrix_top30 != "NORMAL" & !is.na(matrix_top30))

# Sort columns by these frequencies in descending order
sorted_column_indices <- order(mutation_frequencies, decreasing = TRUE)
sorted_final_matrix <- matrix_top30[, sorted_column_indices]

# Clean up naming
sorted_final_matrix[sorted_final_matrix == "NORMAL"] <- ""
sorted_final_matrix[is.na(sorted_final_matrix)] <- ""

```

The plot below is an oncplot that summarizes the mutation alterations, tumor mutation burden and frequency of mutations per gene. 
This report includes a summary report for the current 120 patients who have recieved whole exome sequencing. 
Though unclear, variant calling is assumed to be conducted against hg38 as the "normal" reference. A custom variant calling pipeline is under works

```{r GENERATE ONCOPLOT, fig.width=24, fig.height=11}
pdf("~/Projects/JMP_PAC/figures/oncoprint/oncoplot_n120_jmppac_all_patients_top30_mutated_genes.pdf", width = 24, height = 11)
generate_oncoplot(sorted_final_matrix, "Fig-1: JMP PAC Molecular Profile PDAC Oncoplot n=120 ")
dev.off()
```

```{r GENERATE ONCOPLOT, fig.width=24, fig.height=11}
generate_oncoplot(sorted_final_matrix, "Fig-1: JMP PAC Molecular Profile PDAC Oncoplot n=120 ")
```


# DIVIDE PATIENTS BY FATTY LIVER DISEASE STATUS
```{r}
FL <- wts_sequenced[wts_sequenced$`NASH/NAFLD Status (Y/N)` == "Y", ]
tally_fl <- dim(FL)[1]
cat("\n Number of Patients with Fatty Liver Disease:", tally_fl)


nFL <- wts_sequenced[wts_sequenced$`NASH/NAFLD Status (Y/N)` != "Y" , ]
tally_nfl <- dim(nFL)[1]
cat("\n Number of Patients without Fatty Liver Disease:", tally_nfl)


# PIE CHART FOR PATIENTS WITH AND WITHOUT FLD
data <- c(tally_fl, tally_nfl)
labels <- c("NAFLD", "non-NAFLD")

piepercent<- round(100 * data / sum(data), 1)
# Plot the chart.
pie(data, labels = piepercent,
    main = "Proportion of Patients with NALFD vs non-NAFLD", col = rainbow(length(labels)))
legend("topright", labels ,
                    cex = 0.5, fill = rainbow(length(labels)))

```
## Dividing Patients into two groups
1. NAFLD patients (43)
2. non-NAFLD patients (77), note that this includes 1 unknown who required review

```{r}
sorted_final_df <- as.data.frame(sorted_final_matrix)

# NAFLD 
nafld_matrix <- sorted_final_df %>%
  dplyr::select(one_of(FL$`JMP_PAC ID`)) %>%
  as.matrix()
# View the selected matrix
dim(nafld_matrix)


# non-NAFLD 
nfld_matrix <- sorted_final_df %>%
  dplyr::select(one_of(nFL$`JMP_PAC ID`)) %>%
  as.matrix()
# View the selected matrix
dim(nfld_matrix)

```



```{r GENERATE NAFLD ONCOPLOT, fig.width=24, fig.height=11}
generate_oncoplot(nafld_matrix, "Fig-2: NAFLD Profile PDAC Oncoplot n=43")
```

```{r SAVE NAFLD ONCOPLOT, fig.width=24, fig.height=11}
pdf("~/Projects/JMP_PAC/figures/oncoprint/oncoplot_n43_jmppac_NAFLD_patients_top30_mutated_genes.pdf", width = 24, height = 11)
generate_oncoplot(nafld_matrix, "Fig-2: NAFLD Profile PDAC Oncoplot n=43")
dev.off()
```




```{r GENERATE non-NAFLD ONCOPLOT, fig.width=24, fig.height=11}
generate_oncoplot(nfld_matrix, "Fig-3: NAFLD Profile PDAC Oncoplot n=77")
```

```{r SAVE non-NAFLD ONCOPLOT, fig.width=24, fig.height=11}
pdf("~/Projects/JMP_PAC/figures/oncoprint/oncoplot_n77_jmppac_NAFLD_patients_top30_mutated_genes.pdf", width = 24, height = 11)
generate_oncoplot(nfld_matrix, "Fig-3: NAFLD Profile PDAC Oncoplot n=77")
dev.off()
```






